# 内存管理与缓存驱逐策略改进

本文档描述了对Arkview项目中内存管理和缓存驱逐策略的改进。

## 改进概述

我们对缓存系统进行了重大改进，以更好地管理内存使用并实现更智能的驱逐策略。主要改进包括：

### 1. 更精确的内存估算

之前的内存估算方法过于简化，只考虑了基本的像素数据大小。新的实现考虑了以下几个方面：

- 色彩通道数量和每通道位数
- 图像元数据开销
- Python对象本身的开销

### 2. 软引用与弱引用机制

虽然没有直接使用weakref模块，但我们通过主动管理图像对象的生命周期来模拟类似的效果：

- 当缓存项被驱逐时，主动调用图像对象的`close()`方法
- 定期触发垃圾回收以释放不再使用的对象

### 3. 自适应驱逐策略

实现了两种缓存策略：

1. **LRU (Least Recently Used)** - 最近最少使用
2. **LFU (Least Frequently Used)** - 最少频繁使用

### 4. 内存阈值控制

新增了基于内存使用量的控制机制：

- 可设置最大内存使用量阈值
- 当接近阈值时主动驱逐缓存项
- 可选地结合系统内存监控动态调整缓存大小

## 新增类和功能

### MemoryAwareCacheService

这是新的缓存服务类，提供了改进的内存管理功能：

- 支持基于内存使用量的驱逐策略
- 可选择使用LRU或LFU缓存算法
- 集成了系统内存监控（如果安装了psutil）

### LFUCache

实现了最少频繁使用算法的缓存：

- 跟踪每个缓存项的访问频率
- 优先驱逐访问频率最低的项
- 结合内存使用量控制

## 使用示例

```python
# 创建一个基于LFU策略的缓存服务，最大内存200MB
cache_service = MemoryAwareCacheService(max_items=50, max_memory_mb=200, use_lfu=True)

# 或者使用传统的LRU策略
cache_service = MemoryAwareCacheService(max_items=50, max_memory_mb=200, use_lfu=False)
```

## 依赖项

为了启用系统内存监控功能，可以选择安装psutil库：

```bash
pip install psutil
```

如果没有安装psutil，相关的系统内存监控功能将自动禁用。

## 性能优势

这些改进带来了以下好处：

1. **更准确的内存控制** - 避免了由于内存估算不准确导致的问题
2. **更好的性能** - 智能驱逐策略提高了缓存命中率
3. **更强的适应性** - 可以根据系统资源动态调整缓存行为
4. **更高的稳定性** - 降低了内存溢出的风险

## 向后兼容性

原有的`UnifiedCacheService`类保持不变，确保现有代码无需修改即可继续工作。新的改进功能通过新增的类提供，用户可以根据需要选择使用。